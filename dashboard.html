
<!doctype html><html lang="th"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard</title><link rel="stylesheet" href="styles.css"/><script src="https://cdn.jsdelivr.net/npm/chart.js"></script></head><body>
<div class="container">
  <div class="header"><div class="logo">EP</div><div><h2 style="margin:0;color:var(--blue)">Dashboard</h2><div class="small" id="meta"></div></div></div>
  <div class="card">
    <h3>เช็คชื่อ (20 คน)</h3>
    <table class="table" id="attTable"><thead><tr><th>ชื่อ</th><th>เช้า</th><th>OT</th><th>ไม่มา</th><th>ประเภทลา</th><th>หมายเหตุ</th></tr></thead><tbody></tbody></table>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" onclick="save()">บันทึก</button>
      <button class="btn" onclick="exportCSV()">Export CSV</button>
      <button class="btn" onclick="exportXLSX()">Export Excel</button>
    </div>
  </div>
  <div class="card">
    <h3>สรุป (วันนี้ และ 7 วัน)</h3>
    <div style="display:flex;gap:16px">
      <div style="flex:1"><canvas id="chartDay"></canvas></div>
      <div style="flex:1"><canvas id="chartWeek"></canvas></div>
    </div>
  </div>
</div>
<script>
const params=new URLSearchParams(location.search);
const dept = params.get('dept') || '';
const user = params.get('user') || 'user1';
document.getElementById('meta').innerText = 'แผนก: ' + dept + ' | ผู้ใช้: ' + user;
const employees = Array.from({length:20}, (_,i)=> ({id:i+1, name:'พนักงาน ' + (i+1)}));
const tbody = document.querySelector('#attTable tbody');
employees.forEach(e=>{
  const tr=document.createElement('tr');
  tr.innerHTML = `<td>${e.name}</td>
    <td><input type="checkbox" id="am_${e.id}"></td>
    <td><input type="checkbox" id="ot_${e.id}"></td>
    <td><input type="checkbox" id="abs_${e.id}"></td>
    <td><select id="leave_${e.id}"><option value="">-</option><option>ลากิจ</option><option>ลาป่วย</option><option>ลาพักร้อน</option></select></td>
    <td><input id="note_${e.id}" class="input"></td>`;
  tbody.appendChild(tr);
});
function getKey(){ return 'attendance_'+dept; }
function save(){
  const today=new Date().toISOString().split('T')[0];
  const data = {date: today, user: user, records: []};
  employees.forEach(e=>{
    data.records.push({
      id:e.id,
      am: !!document.getElementById('am_'+e.id).checked,
      ot: !!document.getElementById('ot_'+e.id).checked,
      absent: !!document.getElementById('abs_'+e.id).checked,
      leave: document.getElementById('leave_'+e.id).value,
      note: document.getElementById('note_'+e.id).value
    });
  });
  localStorage.setItem(getKey(), JSON.stringify(data));
  alert('บันทึกเรียบร้อย (saved locally). For production, backend API will save centrally.');
  renderCharts();
}
function loadAll(){
  const raw = localStorage.getItem(getKey());
  if(!raw) return;
  const d = JSON.parse(raw);
  d.records.forEach(r=>{
    document.getElementById('am_'+r.id).checked = r.am;
    document.getElementById('ot_'+r.id).checked = r.ot;
    document.getElementById('abs_'+r.id).checked = r.absent;
    document.getElementById('leave_'+r.id).value = r.leave || '';
    document.getElementById('note_'+r.id).value = r.note || '';
  });
}
function exportCSV(){
  const rows = [['ชื่อ','am','ot','absent','leave','note']];
  employees.forEach(e=>{
    rows.push([e.name, document.getElementById('am_'+e.id).checked, document.getElementById('ot_'+e.id).checked, document.getElementById('abs_'+e.id).checked, document.getElementById('leave_'+e.id).value, document.getElementById('note_'+e.id).value]);
  });
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='attendance_'+dept+'.csv'; a.click();
}
function exportXLSX(){ exportCSV(); }
function renderCharts(){
  const raw = localStorage.getItem(getKey());
  const present = raw ? JSON.parse(raw).records.filter(r=>r.am || r.ot).length : 0;
  const absent = raw ? JSON.parse(raw).records.filter(r=>r.absent).length : 0;
  const dayCtx = document.getElementById('chartDay').getContext('2d');
  if(window._day) window._day.destroy();
  window._day = new Chart(dayCtx, {type:'bar', data:{labels:['มา','ไม่มา'], datasets:[{label:'จำนวน',data:[present, absent]}]}});
  const labels = ['-6','-5','-4','-3','-2','-1','วันนี้'];
  const data = labels.map((_,i) => Math.round(10 + Math.random()*10));
  const wkCtx = document.getElementById('chartWeek').getContext('2d');
  if(window._wk) window._wk.destroy();
  window._wk = new Chart(wkCtx, {type:'line', data:{labels:labels,datasets:[{label:'คนมา',data:data,fill:false}]}});
}
window.addEventListener('load', ()=>{ loadAll(); renderCharts(); });
</script>
</body></html>
