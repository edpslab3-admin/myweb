<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Attendance System</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  body{padding:20px;background:#f4f6f9}
  .container{max-width:900px;margin:0 auto}
  .card{border-radius:12px}
  .checkbox-list label{display:block;padding:4px 0}
</style>
</head>
<body>
<div class="container">
  <h2 class="mb-3">ระบบเช็คชื่อ (Shared)</h2>

  <!-- Login box -->
  <div id="loginBox" class="card p-4 mb-3">
    <h5>เข้าสู่ระบบ Admin</h5>
    <div class="mb-2"><input id="loginUser" class="form-control" placeholder="ชื่อผู้ใช้"></div>
    <div class="mb-2"><input id="loginPass" class="form-control" placeholder="รหัสผ่าน" type="password"></div>
    <div><button class="btn btn-primary" onclick="doLogin()">เข้าสู่ระบบ</button></div>
    <div id="loginMsg" class="text-danger mt-2"></div>
  </div>

  <!-- Main box - hidden until login -->
  <div id="mainBox" style="display:none;">
    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong id="adminName"></strong>
        </div>
        <div>
          <button class="btn btn-secondary btn-sm" onclick="doLogout()">ออกจากระบบ</button>
        </div>
      </div>
      <hr>
      <h5>เช็คชื่อ</h5>
      <div class="checkbox-list" id="checkboxList"></div>

      <div class="mt-2">
        <button class="btn btn-success" onclick="saveAttendance()">บันทึกสถานะ (เซฟที่ server)</button>
        <button class="btn btn-outline-primary" onclick="exportCSV()">ดาวน์โหลด CSV</button>
        <button class="btn btn-outline-primary" onclick="exportXLSX()">ดาวน์โหลด Excel</button>
        <button class="btn btn-info" onclick="showDashboard()">สรุป / แดชบอร์ด</button>
      </div>

      <div id="statusMsg" class="mt-2"></div>
    </div>

    <div id="dashboard" class="card p-3" style="display:none;">
      <h5>สรุปรายวัน / รายสัปดาห์</h5>
      <div class="row">
        <div class="col-md-6">
          <h6>วันนี้</h6>
          <canvas id="chartDay" height="150"></canvas>
        </div>
        <div class="col-md-6">
          <h6>สัปดาห์ล่าสุด (7 วัน)</h6>
          <canvas id="chartWeek" height="150"></canvas>
        </div>
      </div>

      <hr>
      <h6>สรุปรายบุคคล (รายสัปดาห์)</h6>
      <div id="personSummary"></div>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ======
 * ถ้า backend deploy อยู่ที่อื่นให้แก้เป็น URL ของ backend เช่น:
 * const API = 'https://my-attend-backend.onrender.com'
 * ถ้าวาง frontend และ backend ในเดียวกัน ให้ใช้ location.origin
 */
const API = location.origin; // <-- ถ้าบน Render ให้เปลี่ยนเป็น URL ของ Render (เช่น https://myweb-xxxxx.onrender.com)
let employees = [];
let token = null;
let adminUser = null;

/* โหลดรายชื่อจาก backend */
async function loadUsers(){
  const res = await fetch(API + '/users');
  const data = await res.json();
  employees = data.employees || [];
  renderCheckboxes();
}

/* render checkboxes */
function renderCheckboxes(){
  const c = document.getElementById('checkboxList');
  c.innerHTML = '';
  employees.forEach((name,i)=>{
    const id = 'chk_'+i;
    const wrap = document.createElement('div');
    wrap.innerHTML = `<label><input id="${id}" type="checkbox"> ${name}</label>`;
    c.appendChild(wrap);
  });
}

/* login */
async function doLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  document.getElementById('loginMsg').innerText = '';
  try {
    const res = await fetch(API + '/login', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({user:u, pass:p})
    });
    if (!res.ok) {
      const e = await res.json().catch(()=>({}));
      document.getElementById('loginMsg').innerText = 'เข้าสู่ระบบไม่สำเร็จ';
      return;
    }
    const j = await res.json();
    token = j.token;
    adminUser = j.user;
    document.getElementById('adminName').innerText = 'Admin: ' + adminUser;
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('mainBox').style.display = 'block';
    await loadUsers();
    await loadToday();
  } catch(err){
    document.getElementById('loginMsg').innerText = 'เกิดข้อผิดพลาด';
  }
}

/* logout */
async function doLogout(){
  await fetch(API + '/logout', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({token})});
  token = null; adminUser = null;
  document.getElementById('mainBox').style.display = 'none';
  document.getElementById('loginBox').style.display = 'block';
}

/* โหลดสถานะวันนี้จาก server */
async function loadToday(){
  const date = new Date().toISOString().split('T')[0];
  const res = await fetch(API + '/attendance');
  const data = await res.json();
  if (data && data[date]) {
    const arr = data[date];
    arr.forEach((v,i)=>{
      const el = document.getElementById('chk_'+i);
      if (el) el.checked = !!v;
    });
  } else {
    // default unchecked
  }
}

/* save attendance (ต้องมี token) */
async function saveAttendance(){
  if (!token) { alert('ต้องล็อกอินก่อน'); return; }
  const date = new Date().toISOString().split('T')[0];
  const status = employees.map((_,i)=> !!document.getElementById('chk_'+i).checked );
  const res = await fetch(API + '/attendance', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({date, status, token})
  });
  if (res.ok) {
    document.getElementById('statusMsg').innerText = 'บันทึกเรียบร้อย';
  } else {
    document.getElementById('statusMsg').innerText = 'บันทึกไม่สำเร็จ';
  }
}

/* Export CSV & XLSX */
function exportCSV(){
  const date = new Date().toISOString().split('T')[0];
  const rows = [['ชื่อ','สถานะ']];
  employees.forEach((name,i)=>{
    rows.push([name, document.getElementById('chk_'+i).checked ? 'มา' : 'ไม่มา']);
  });
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `attendance_${date}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function exportXLSX(){
  const rows = [['ชื่อ','สถานะ']];
  employees.forEach((name,i)=>{
    rows.push([name, document.getElementById('chk_'+i).checked ? 'มา' : 'ไม่มา']);
  });
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
  XLSX.writeFile(wb, `attendance_${new Date().toISOString().split('T')[0]}.xlsx`);
}

/* Dashboard: daily and weekly summaries */
async function showDashboard(){
  document.getElementById('dashboard').style.display = 'block';
  const res = await fetch(API + '/attendance');
  const db = await res.json();
  renderSummary(db);
}

function renderSummary(db){
  // today
  const date = new Date().toISOString().split('T')[0];
  const todayArr = db[date] || employees.map(()=>false);
  const present = todayArr.filter(Boolean).length;
  const absent = todayArr.length - present;

  // week (last 7 days)
  const dates = [];
  for (let i=6;i>=0;i--){
    const d = new Date();
    d.setDate(d.getDate() - i);
    dates.push(d.toISOString().split('T')[0]);
  }
  const weekCounts = dates.map(d => {
    const arr = db[d] || employees.map(()=>false);
    return arr.filter(Boolean).length;
  });

  // chart day
  const chartDayCtx = document.getElementById('chartDay').getContext('2d');
  if (window._chartDay) window._chartDay.destroy();
  window._chartDay = new Chart(chartDayCtx, {
    type:'bar',
    data:{
      labels:['มา','ไม่มา'],
      datasets:[{label:'จำนวน', data:[present, absent], backgroundColor:['#2ecc71','#e74c3c']}]
    },
    options:{plugins:{legend:{display:false}}}
  });

  // chart week
  const chartWeekCtx = document.getElementById('chartWeek').getContext('2d');
  if (window._chartWeek) window._chartWeek.destroy();
  window._chartWeek = new Chart(chartWeekCtx, {
    type:'line',
    data:{
      labels: dates,
      datasets:[{label:'คนมา', data: weekCounts, fill:false, tension:0.3}]
    },
    options:{plugins:{legend:{display:false}}}
  });

  // per person summary for last 7 days
  const personDiv = document.getElementById('personSummary');
  personDiv.innerHTML = '';
  employees.forEach((name, idx)=>{
    let came = 0;
    dates.forEach(d=>{
      const arr = db[d] || [];
      if (arr[idx]) came++;
    });
    const el = document.createElement('div');
    el.className = 'mb-1';
    el.innerHTML = `<strong>${name}</strong>: มา ${came} / ${dates.length} วัน`;
    personDiv.appendChild(el);
  });
}

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  // if want to auto show loginBox only
});
</script>
</body>
</html>
