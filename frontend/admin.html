<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin</title>

  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <div class="logo">EP</div>
      <div>
        <h2 style="margin:0; color:var(--blue)">Admin Dashboard</h2>
        <div class="small">ภาพรวมองค์กร</div>
      </div>
    </div>

    <!-- Chart Card -->
    <div class="card">
      <h3>สรุปตามแผนก</h3>

      <div style="display:flex; gap:12px">
        <div style="flex:1">
          <canvas id="deptChart"></canvas>
        </div>

        <div style="flex:1">
          <canvas id="leaveChart"></canvas>
        </div>
      </div>

      <div style="margin-top:12px">
        <button class="btn" onclick="exportOrg()">
          Export Organization CSV
        </button>
      </div>
    </div>

    <!-- Raw Data Card -->
    <div class="card">
      <h3>ดาต้าทั้งหมด</h3>
      <pre id="raw"></pre>
    </div>

  </div>

  <script>
    async function loadAll() {
      const response = await fetch('/api/all');
      const db = await response.json();

      // Show raw JSON
      document.getElementById('raw').innerText = JSON.stringify(db, null, 2);

      // Prepare department chart
      const depts = Object.keys(db.departments);
      const counts = depts.map(d => {
        const v = db.departments[d];
        if (!v || !v.records) return 0;
        return v.records.filter(r => r.am || r.ot).length;
      });

      const ctxDept = document.getElementById('deptChart');
      new Chart(ctxDept, {
        type: 'bar',
        data: {
          labels: depts,
          datasets: [{
            label: 'คนมา (วันนี้)',
            data: counts
          }]
        }
      });

      // Prepare leave summary
      const leaves = {
        ลากิจ: 0,
        ลาป่วย: 0,
        ลาพักร้อน: 0
      };

      Object.values(db.departments).forEach(v => {
        if (!v || !v.records) return;
        v.records.forEach(r => {
          if (r.leave) {
            leaves[r.leave] = (leaves[r.leave] || 0) + 1;
          }
        });
      });

      const ctxLeave = document.getElementById('leaveChart');
      new Chart(ctxLeave, {
        type: 'pie',
        data: {
          labels: Object.keys(leaves),
          datasets: [{
            data: Object.values(leaves)
          }]
        }
      });
    }

    function exportOrg() {
      location.href = '/api/export';
    }

    // Load data when page loads
    window.addEventListener('load', loadAll);
  </script>

</body>
</html>
