<!DOCTYPE html><html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Attendance</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  body{font-family:sans-serif; background:#f0f2f5; margin:0; padding:20px}
  .container{max-width:1200px; margin:auto}
  .header{display:flex; gap:16px; align-items:center; margin-bottom:20px}
  .logo{font-weight:bold; font-size:24px; color:var(--blue,#007bff)}
  .small{font-size:14px; color:#555}
  .card{background:white; padding:16px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1)}
  .table{width:100%; border-collapse:collapse}
  .table th, .table td{border:1px solid #ddd; padding:8px; text-align:center}
  .btn{padding:6px 12px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer}
  .btn:hover{background:#0056b3}
</style>
</head>
<body><div class="container">
  <div class="header">
    <div class="logo">EP</div>
    <div>
      <h2 style="margin:0; color:var(--blue)">Dashboard</h2>
      <div class="small" id="meta"></div>
    </div>
  </div>  <div class="card">
    <h3 id="titleDept"></h3>
    <div id="summaryToday" style="margin-bottom:12px"></div>
    <table class="table" id="attTable">
      <thead>
        <tr>
          <th>ชื่อ</th>
          <th>ตำแหน่ง</th>
          <th>เช้า</th>
          <th>OT</th>
          <th>ไม่มา</th>
          <th>ประเภทลา</th>
          <th>หมายเหตุ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="btn" id="saveBtn">บันทึก</button>
      <button class="btn" id="xlsBtn">Export Excel</button>
    </div>
  </div>  <div class="card">
    <h3>กราฟสรุป</h3>
    <div style="display:flex; gap:16px; flex-wrap:wrap;">
      <div style="flex:1; min-width:300px"><canvas id="chartDay"></canvas></div>
      <div style="flex:1; min-width:300px"><canvas id="chartWeek"></canvas></div>
      <div style="flex:1; min-width:300px"><canvas id="chartMonth"></canvas></div>
    </div>
  </div>
</div><button id="logoutBtn" style="position:fixed; top:20px; right:20px; padding:10px 20px; background:#d9534f; color:white; border:none; border-radius:6px; cursor:pointer;">ออกจากระบบ</button>

<script>
// ---------- ข้อมูลพนักงาน ----------
const employeesDB = {
"เช็ค100% กะ1":[
{ "id":1, "name":"อนุชา ร้อยเส้น", "position":"Operator" },
{ "id":2, "name":"ศิวะพงษ์ บุญมาก", "position":"Supervisor" },
{ "id":3, "name":"ภาณุวัฒน์ จันทรา", "position":"Operator" },
{ "id":4, "name":"สมปอง ปักเชือก", "position":"Operator" },
{ "id":5, "name":"สุริยา ดวงทอง", "position":"Operator" },
{ "id":6, "name":"นรินทร์ มั่นดี", "position":"Operator" },
{ "id":7, "name":"ธีรพงษ์ คำดี", "position":"Operator" },
{ "id":8, "name":"วรเมธ ใจแกร่ง", "position":"Operator" },
{ "id":9, "name":"พิชัย อารีย์", "position":"Operator" },
{ "id":10, "name":"ศุภชัย นิ่มนวล", "position":"Operator" },
{ "id":11, "name":"อดิเรก พูนศักดิ์", "position":"Operator" },
{ "id":12, "name":"ธนดล ใจบุญ", "position":"Operator" },
{ "id":13, "name":"สุทธิพงษ์ ศักดิ์ชัย", "position":"Operator" },
{ "id":14, "name":"เจษฎา คงทน", "position":"Operator" },
{ "id":15, "name":"จิรภัทร ทองแท้", "position":"Operator" },
{ "id":16, "name":"วีรภัทร ดวงดี", "position":"Operator" },
{ "id":17, "name":"ภาณุเดช แซ่ตั้ง", "position":"Operator" },
{ "id":18, "name":"ชานนท์ จันทรวงศ์", "position":"Operator" },
{ "id":19, "name":"ปิยวัฒน์ ศรีสุข", "position":"Operator" },
{ "id":20, "name":"ดนัย ปัญญา", "position":"Operator" }
],
"เช็ค100% กะ2":[
{ "id":1, "name":"สุริยา ดวงทอง", "position":"Operator" },
{ "id":2, "name":"ธีรพงษ์ คำดี", "position":"Operator" },
{ "id":3, "name":"วรเมธ ใจแกร่ง", "position":"Operator" },
{ "id":4, "name":"พิชัย อารีย์", "position":"Operator" },
{ "id":5, "name":"ศุภชัย นิ่มนวล", "position":"Operator" },
{ "id":6, "name":"อดิเรก พูนศักดิ์", "position":"Operator" },
{ "id":7, "name":"ธนดล ใจบุญ", "position":"Operator" },
{ "id":8, "name":"สุทธิพงษ์ ศักดิ์ชัย", "position":"Operator" },
{ "id":9, "name":"เจษฎา คงทน", "position":"Operator" },
{ "id":10, "name":"จิรภัทร ทองแท้", "position":"Operator" },
{ "id":11, "name":"วีรภัทร ดวงดี", "position":"Operator" },
{ "id":12, "name":"ภาณุเดช แซ่ตั้ง", "position":"Operator" },
{ "id":13, "name":"ชานนท์ จันทรวงศ์", "position":"Operator" },
{ "id":14, "name":"ปิยวัฒน์ ศรีสุข", "position":"Operator" },
{ "id":15, "name":"ดนัย ปัญญา", "position":"Operator" },
{ "id":16, "name":"อนุชา ร้อยเส้น", "position":"Operator" },
{ "id":17, "name":"ศิวะพงษ์ บุญมาก", "position":"Supervisor" },
{ "id":18, "name":"ภาณุวัฒน์ จันทรา", "position":"Operator" },
{ "id":19, "name":"สมปอง ปักเชือก", "position":"Operator" },
{ "id":20, "name":"สุริยา ดวงทอง", "position":"Operator" }
],
"แพ็คกิ้ง":[
{ "id":1, "name":"ภาณุวัฒน์ จันทรา", "position":"Operator" },
{ "id":2, "name":"สมปอง ปักเชือก", "position":"Operator" },
{ "id":3, "name":"สุริยา ดวงทอง", "position":"Operator" },
{ "id":4, "name":"นรินทร์ มั่นดี", "position":"Operator" },
{ "id":5, "name":"ธีรพงษ์ คำดี", "position":"Operator" },
{ "id":6, "name":"วรเมธ ใจแกร่ง", "position":"Operator" },
{ "id":7, "name":"พิชัย อารีย์", "position":"Operator" },
{ "id":8, "name":"ศุภชัย นิ่มนวล", "position":"Operator" },
{ "id":9, "name":"อดิเรก พูนศักดิ์", "position":"Operator" },
{ "id":10, "name":"ธนดล ใจบุญ", "position":"Operator" },
{ "id":11, "name":"สุทธิพงษ์ ศักดิ์ชัย", "position":"Operator" },
{ "id":12, "name":"เจษฎา คงทน", "position":"Operator" },
{ "id":13, "name":"จิรภัทร ทองแท้", "position":"Operator" },
{ "id":14, "name":"วีรภัทร ดวงดี", "position":"Operator" },
{ "id":15, "name":"ภาณุเดช แซ่ตั้ง", "position":"Operator" },
{ "id":16, "name":"ชานนท์ จันทรวงศ์", "position":"Operator" },
{ "id":17, "name":"ปิยวัฒน์ ศรีสุข", "position":"Operator" },
{ "id":18, "name":"ดนัย ปัญญา", "position":"Operator" },
{ "id":19, "name":"อนุชา ร้อยเส้น", "position":"Operator" },
{ "id":20, "name":"ศิวะพงษ์ บุญมาก", "position":"Supervisor" }
],
"ผลิต":[
{ "id":1, "name":"ธีรพงษ์ คำดี", "position":"Operator" },
{ "id":2, "name":"วรเมธ ใจแกร่ง", "position":"Operator" },
{ "id":3, "name":"พิชัย อารีย์", "position":"Operator" },
{ "id":4, "name":"ศุภชัย นิ่มนวล", "position":"Operator" },
{ "id":5, "name":"อดิเรก พูนศักดิ์", "position":"Operator" },
{ "id":6, "name":"ธนดล ใจบุญ", "position":"Operator" },
{ "id":7, "name":"สุทธิพงษ์ ศักดิ์ชัย", "position":"Operator" },
{ "id":8, "name":"เจษฎา คงทน", "position":"Operator" },
{ "id":9, "name":"จิรภัทร ทองแท้", "position":"Operator" },
{ "id":10, "name":"วีรภัทร ดวงดี", "position":"Operator" },
{ "id":11, "name":"ภาณุเดช แซ่ตั้ง", "position":"Operator" },
{ "id":12, "name":"ชานนท์ จันทรวงศ์", "position":"Operator" },
{ "id":13, "name":"ปิยวัฒน์ ศรีสุข", "position":"Operator" },
{ "id":14, "name":"ดนัย ปัญญา", "position":"Operator" },
{ "id":15, "name":"อนุชา ร้อยเส้น", "position":"Operator" },
{ "id":16, "name":"ศิวะพงษ์ บุญมาก", "position":"Supervisor" },
{ "id":17, "name":"ภาณุวัฒน์ จันทรา", "position":"Operator" },
{ "id":18, "name":"สมปอง ปักเชือก", "position":"Operator" },
{ "id":19, "name":"สุริยา ดวงทอง", "position":"Operator" },
{ "id":20, "name":"นรินทร์ มั่นดี", "position":"Operator" }
]
};

// ---------- แผนกจาก URL ----------
let dept = new URLSearchParams(location.search).get("dept") || "เช็ค100% กะ1";
const user = new URLSearchParams(location.search).get("user") || "user1";
if(!employeesDB[dept]) dept="เช็ค100% กะ1";
document.getElementById("meta").innerText = "แผนก: " + dept + " | ผู้ใช้: " + user;
document.getElementById("titleDept").innerText = "เช็คชื่อ (" + dept + ")";

// ---------- สร้างตาราง ----------
function buildTable(){
  const tbody=document.querySelector("#attTable tbody");
  tbody.innerHTML="";
  employeesDB[dept].forEach(e=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${e.name}</td>
      <td>${e.position}</td>
      <td><input type="checkbox" id="am_${e.id}" onchange="checkConflict(${e.id})"></td>
      <td><input type="checkbox" id="ot_${e.id}" onchange="checkConflict(${e.id})"></td>
      <td><input type="checkbox" id="abs_${e.id}" onchange="checkConflict(${e.id})"></td>
      <td>
        <select id="leave_${e.id}">
          <option value="">-</option>
          <option value="ลากิจ">ลากิจ</option>
          <option value="ลาป่วย">ลาป่วย</option>
          <option value="ลาพักร้อน">ลาพักร้อน</option>
        </select>
      </td>
      <td><input id="note_${e.id}"></td>
    `;
    tbody.appendChild(tr);
  });
}
window.checkConflict = function(id){
  const am=document.getElementById("am_"+id);
  const ot=document.getElementById("ot_"+id);
  const abs=document.getElementById("abs_"+id);
  if(abs.checked){am.checked=false; ot.checked=false;}
  if(am.checked||ot.checked){abs.checked=false;}
}
function collectRecords(){
  return Array.from(document.querySelectorAll("#attTable tbody tr")).map((tr,i)=>{
    const id=i+1;
    return {
      id,
      name:tr.cells[0].innerText,
      position:tr.cells[1].innerText,
      am:tr.cells[2].querySelector("input").checked,
      ot:tr.cells[3].querySelector("input").checked,
      absent:tr.cells[4].querySelector("input").checked,
      leave:tr.cells[5].querySelector("select").value,
      note:tr.cells[6].querySelector("input").value
    };
  });
}

// ---------- บันทึก ----------
document.getElementById("saveBtn").addEventListener("click", ()=>{
  const records=collectRecords();
  const date=new Date().toISOString().slice(0,10);
  const all=JSON.parse(localStorage.getItem("attendance_all")||"{}");
  if(!all[date]) all[date]={};
  all[date][dept]=records;
  localStorage.setItem("attendance_all",JSON.stringify(all));
  alert("บันทึกเรียบร้อยแล้ว");
  buildCharts();
});

// ---------- Export Excel ----------
document.getElementById("xlsBtn").addEventListener("click", ()=>{
  const all=JSON.parse(localStorage.getItem("attendance_all")||"{}");
  const wb=XLSX.utils.book_new();
  Object.entries(all).forEach(([date,depts])=>{
    if(!depts[dept]) return;
    const records = depts[dept].map(r=>{
      return {
        วันที่: date,
        แผนก: dept,
        ชื่อ: r.name,
        ตำแหน่ง: r.position,
        เช้า: r.am ? "มา" : "-",
        OT: r.ot ? "ทำ OT" : "-",
        ไม่มา: r.absent ? "ไม่มา" : "-",
        ประเภทลา: r.leave || "-",
        หมายเหตุ: r.note || "-"
      };
    });
    const ws=XLSX.utils.json_to_sheet(records);
    XLSX.utils.book_append_sheet(wb,ws,`${dept}_${date}`);
  });
  XLSX.writeFile(wb,"attendance.xlsx");
});

// ---------- กราฟ ----------
let charts = [];
function buildCharts(){
  const all=JSON.parse(localStorage.getItem("attendance_all")||"{}");
  const today=new Date().toISOString().slice(0,10);
  const todayRecords=(all[today]&&all[today][dept])||[];

  const presentCount = todayRecords.filter(r=>r.am||r.ot).length;
  const absentCount = todayRecords.filter(r=>r.absent).length;
  document.getElementById("summaryToday").innerHTML=`<b>วันนี้มา:</b> ${presentCount} คน | <b>ไม่มา:</b> ${absentCount} คน`;

  buildBarChart("chartDay",todayRecords);
  buildSummaryChart("chartWeek",summarizePeriod(all,7));
  buildSummaryChart("chartMonth",summarizePeriod(all,30));
}

function summarizePeriod(allData,days){
  const summary={};
  const dates=Object.keys(allData).sort().slice(-days);
  dates.forEach(date=>{
    const depts=allData[date];
    if(!depts[dept]) return;
    depts[dept].forEach(r=>{
      if(!summary[r.name]) summary[r.name]={am:0,ot:0,absent:0};
      if(r.am) summary[r.name
