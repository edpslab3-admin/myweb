<!DOCTYPE html><html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Attendance</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">  <!-- Header -->  <div class="header">
    <div class="logo">EP</div>
    <div>
      <h2 style="margin:0; color:var(--blue)">Dashboard</h2>
      <div class="small" id="meta"></div>
    </div>
  </div>  <!-- Attendance Table -->  <div class="card">
    <h3 id="titleDept"></h3>
    <table class="table" id="attTable">
      <thead>
        <tr>
          <th>ชื่อ</th>
          <th>ตำแหน่ง</th>
          <th>เช้า</th>
          <th>OT</th>
          <th>ไม่มา</th>
          <th>ประเภทลา</th>
          <th>หมายเหตุ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="btn" id="saveBtn">บันทึก</button>
      <button class="btn" id="csvBtn">Export CSV</button>
      <button class="btn" id="xlsBtn">Export Excel</button>
    </div>
  </div>  <!-- Charts -->  <div class="card">
    <h3>กราฟสรุปการเข้าทำงาน</h3>
    <div style="display:flex; gap:16px;">
      <div style="flex:1"><canvas id="chartDay"></canvas></div>
      <div style="flex:1"><canvas id="chartWeek"></canvas></div>
      <div style="flex:1"><canvas id="chartMonth"></canvas></div>
    </div>
  </div>
</div><!-- Logout --><button id="logoutBtn" style="position:fixed; top:20px; right:20px; padding:10px 20px; background:#d9534f; color:white; border:none; border-radius:6px; cursor:pointer;">ออกจากระบบ</button>

<script>
const params = new URLSearchParams(location.search);
let dept = params.get("dept") || "เช็ค100% กะ1";
const user = params.get("user") || "user1";
document.getElementById("meta").innerText = "แผนก: " + dept + " | ผู้ใช้: " + user;
document.getElementById("titleDept").innerText = "เช็คชื่อ (" + dept + ")";

let employees = [];
let attendanceData = {};

// โหลดรายชื่อจาก Server
async function getEmployees(){
  const res = await fetch('/employees');
  const data = await res.json();
  employees = data[dept] || [];
  buildTable();
}

// สร้างตาราง
function buildTable(){
  const tbody = document.querySelector("#attTable tbody");
  tbody.innerHTML = '';
  employees.forEach(e=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.name}</td>
      <td>${e.position}</td>
      <td><input type="checkbox" id="am_${e.id}" onchange="checkConflict(${e.id})"></td>
      <td><input type="checkbox" id="ot_${e.id}" onchange="checkConflict(${e.id})"></td>
      <td><input type="checkbox" id="abs_${e.id}" onchange="checkConflict(${e.id})"></td>
      <td>
        <select id="leave_${e.id}">
          <option value="">-</option>
          <option value="ลากิจ">ลากิจ</option>
          <option value="ลาป่วย">ลาป่วย</option>
          <option value="ลาพักร้อน">ลาพักร้อน</option>
        </select>
      </td>
      <td><input id="note_${e.id}"></td>
    `;
    tbody.appendChild(tr);
  });
}

// ป้องกันเลือกสถานะซ้ำ
window.checkConflict = function(id){
  const am = document.getElementById("am_"+id);
  const ot = document.getElementById("ot_"+id);
  const abs = document.getElementById("abs_"+id);
  if(abs.checked){ am.checked=false; ot.checked=false; }
  if(am.checked||ot.checked){ abs.checked=false; }
}

// เก็บข้อมูลจากตาราง
function collectRecords(){
  return Array.from(document.querySelectorAll("#attTable tbody tr")).map((tr,i)=>{
    const id = i+1;
    return {
      id,
      name: tr.cells[0].innerText,
      position: tr.cells[1].innerText,
      am: tr.cells[2].querySelector("input").checked,
      ot: tr.cells[3].querySelector("input").checked,
      absent: tr.cells[4].querySelector("input").checked,
      leave: tr.cells[5].querySelector("select").value,
      note: tr.cells[6].querySelector("input").value
    };
  });
}

// บันทึกไป Server
document.getElementById("saveBtn").addEventListener("click", async ()=>{
  const records = collectRecords();
  const date = new Date().toISOString().slice(0,10);
  const res = await fetch('/attendance',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({dept, records, date})
  });
  const result = await res.json();
  alert("บันทึกแล้ว: "+result.message);
  fetchAttendanceAndDrawCharts();
});

// Export CSV
document.getElementById("csvBtn").addEventListener("click", async ()=>{
  const res = await fetch('/attendance');
  const data = await res.json();
  const csvRows = [["date","dept","id","name","position","am","ot","absent","leave","note"]];
  Object.entries(data).forEach(([date, depts])=>{
    Object.entries(depts).forEach(([d, recs])=>{
      recs.forEach(r=>{
        csvRows.push([date,d,r.id,r.name,r.position,r.am,r.ot,r.absent,r.leave,r.note]);
      });
    });
  });
  const csv = csvRows.map(e=>e.join(",")).join("\n");
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv]));
  a.download = "attendance.csv";
  a.click();
});

// Export Excel
document.getElementById("xlsBtn").addEventListener("click", async ()=>{
  const res = await fetch('/attendance');
  const data = await res.json();
  const wb = XLSX.utils.book_new();
  Object.entries(data).forEach(([date,depts])=>{
    Object.entries(depts).forEach(([d,recs])=>{
      const ws = XLSX.utils.json_to_sheet(recs.map(r=>({...r, date, dept:d})));
      XLSX.utils.book_append_sheet(wb, ws, `${d}_${date}`);
    });
  });
  XLSX.writeFile(wb, "attendance.xlsx");
});

// โหลด attendance จาก server และวาดกราฟ
async function fetchAttendanceAndDrawCharts(){
  const res = await fetch('/attendance');
  attendanceData = await res.json();
  drawCharts();
}

// สร้างกราฟ
let chartDay, chartWeek, chartMonth;
function drawCharts(){
  const today = new Date().toISOString().slice(0,10);
  const days = Object.keys(attendanceData).sort();
  const weeklyCounts = {};
  const monthlyCounts = {};

  // เตรียมข้อมูลรายวัน
  const todayRecords = attendanceData[today]?.[dept] || [];
  const labelsDay = todayRecords.map(r=>r.name);
  const dataDay = todayRecords.map(r=> r.am ? 1 : 0);

  if(chartDay) chartDay.destroy();
  chartDay = new Chart(document.getElementById("chartDay"), {
    type:'bar',
    data:{labels:labelsDay,datasets:[{label:'เช้า',data:dataDay,backgroundColor:'rgba(54,162,235,0.6)'}]},
    options:{responsive:true,plugins:{title:{display:true,text:'รายบุคคล (วันนี้)'}}}
  });

  // เตรียมข้อมูลรายสัปดาห์
  const weekLabels = employees.map(e=>e.name);
  const weekData = weekLabels.map(name=>{
    let count=0;
    days.slice(-7).forEach(day=>{
      const recs = attendanceData[day]?.[dept]||[];
      const r = recs.find(r=>r.name===name);
      if(r && r.am) count++;
    });
    return count;
  });
  if(chartWeek) chartWeek.destroy();
  chartWeek = new Chart(document.getElementById("chartWeek"), {
    type:'bar',
    data:{labels:weekLabels,datasets:[{label:'เช้า',data:weekData,backgroundColor:'rgba(255,159,64,0.6)'}]},
    options:{responsive:true,plugins:{title:{display:true,text:'รายบุคคล (สัปดาห์ล่าสุด)'}}}
  });

  // เตรียมข้อมูลรายเดือน
  const monthLabels = employees.map(e=>e.name);
  const monthData = monthLabels.map(name=>{
    let count=0;
    days.slice(-30).forEach(day=>{
      const recs = attendanceData[day]?.[dept]||[];
      const r = recs.find(r=>r.name===name);
      if(r && r.am) count++;
    });
    return count;
  });
  if(chartMonth) chartMonth.destroy();
  chartMonth = new Chart(document.getElementById("chartMonth"), {
    type:'bar',
    data:{labels:monthLabels,datasets:[{label:'เช้า',data:monthData,backgroundColor:'rgba(75,192,192,0.6)'}]},
    options:{responsive:true,plugins:{title:{display:true,text:'รายบุคคล (เดือนล่าสุด)'}}}
  });
}

// Load employees และ attendance
getEmployees().then(fetchAttendanceAndDrawCharts);

// Logout
document.getElementById("logoutBtn").addEventListener("click",()=>{
  localStorage.removeItem("user_login");
  window.location.href="index.html";
});
</script></body>
</html>
