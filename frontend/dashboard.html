<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>

  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body>

  <div class="container">

    <!-- Header -->
    <div class="header">
      <div class="logo">EP</div>
      <div>
        <h2 style="margin:0; color:var(--blue)">Dashboard</h2>
        <div class="small" id="meta"></div>
      </div>
    </div>

    <!-- Attendance Table -->
    <div class="card">
      <h3 id="titleDept"></h3>

      <table class="table" id="attTable">
        <thead>
          <tr>
            <th>ชื่อ</th>
            <th>เช้า</th>
            <th>OT</th>
            <th>ไม่มา</th>
            <th>ประเภทลา</th>
            <th>หมายเหตุ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn" id="saveBtn">บันทึก</button>
        <button class="btn" id="csvBtn">Export CSV</button>
        <button class="btn" id="xlsBtn">Export Excel</button>
      </div>
    </div>

  </div>

  <!-- Logout Button -->
  <div style="position:fixed; top:20px; right:20px;">
    <button id="logoutBtn"
      style="padding:10px 20px; background-color:#d9534f; color:white;
             border:none; border-radius:6px; cursor:pointer;">
      ออกจากระบบ
    </button>
  </div>

  <script>
    /* -------------------------------------
       รายชื่อพนักงานแต่ละแผนก
    -------------------------------------- */
    const employeesDB = {
      "เช็ค100% กะ1": [
        { "id": 1, "name": "อนุชา ร้อยเส้น" },
        { "id": 2, "name": "ศิวะพงษ์ บุญมาก" },
        { "id": 3, "name": "ภาณุวัฒน์ จันทรา" },
        { "id": 4, "name": "สมปอง ปักเชือก" },
        { "id": 5, "name": "สุริยา ดวงทอง" },
        { "id": 6, "name": "นรินทร์ มั่นดี" },
        { "id": 7, "name": "ธีรพงษ์ คำดี" },
        { "id": 8, "name": "วรเมธ ใจแกร่ง" },
        { "id": 9, "name": "พิชัย อารีย์" },
        { "id": 10, "name": "ศุภชัย นิ่มนวล" },
        { "id": 11, "name": "อดิเรก พูนศักดิ์" },
        { "id": 12, "name": "ธนดล ใจบุญ" },
        { "id": 13, "name": "สุทธิพงษ์ ศักดิ์ชัย" },
        { "id": 14, "name": "เจษฎา คงทน" },
        { "id": 15, "name": "จิรภัทร ทองแท้" }
      ],     
      "เช็ค100% กะ2": [
        { "id": 1, "name": "อนุชา ร้อยเส้น" },
        { "id": 2, "name": "ศิวะพงษ์ บุญมาก" },
        { "id": 3, "name": "ภาณุวัฒน์ จันทรา" },
        { "id": 4, "name": "สมปอง ปักเชือก" },
        { "id": 5, "name": "สุริยา ดวงทอง" },
        { "id": 6, "name": "นรินทร์ มั่นดี" },
        { "id": 7, "name": "ธีรพงษ์ คำดี" },
        { "id": 8, "name": "วรเมธ ใจแกร่ง" },
        { "id": 9, "name": "พิชัย อารีย์" },
        { "id": 10, "name": "ศุภชัย นิ่มนวล" },
        { "id": 11, "name": "อดิเรก พูนศักดิ์" },
        { "id": 12, "name": "ธนดล ใจบุญ" },
        { "id": 13, "name": "สุทธิพงษ์ ศักดิ์ชัย" },
        { "id": 14, "name": "เจษฎา คงทน" },
        { "id": 15, "name": "จิรภัทร ทองแท้" }
      ],
      "แพ็คกิ้ง": [
        { "id": 1, "name": "อนุชา ร้อยเส้น" },
        { "id": 2, "name": "ศิวะพงษ์ บุญมาก" },
        { "id": 3, "name": "ภาณุวัฒน์ จันทรา" },
        { "id": 4, "name": "สมปอง ปักเชือก" },
        { "id": 5, "name": "สุริยา ดวงทอง" },
        { "id": 6, "name": "นรินทร์ มั่นดี" },
        { "id": 7, "name": "ธีรพงษ์ คำดี" },
        { "id": 8, "name": "วรเมธ ใจแกร่ง" },
        { "id": 9, "name": "พิชัย อารีย์" },
        { "id": 10, "name": "ศุภชัย นิ่มนวล" },
        { "id": 11, "name": "อดิเรก พูนศักดิ์" },
        { "id": 12, "name": "ธนดล ใจบุญ" },
        { "id": 13, "name": "สุทธิพงษ์ ศักดิ์ชัย" },
        { "id": 14, "name": "เจษฎา คงทน" },
        { "id": 15, "name": "จิรภัทร ทองแท้" }
      ],
      "ผลิต": [
        { "id": 1, "name": "อนุชา ร้อยเส้น" },
        { "id": 2, "name": "ศิวะพงษ์ บุญมาก" },
        { "id": 3, "name": "ภาณุวัฒน์ จันทรา" },
        { "id": 4, "name": "สมปอง ปักเชือก" },
        { "id": 5, "name": "สุริยา ดวงทอง" },
        { "id": 6, "name": "นรินทร์ มั่นดี" },
        { "id": 7, "name": "ธีรพงษ์ คำดี" },
        { "id": 8, "name": "วรเมธ ใจแกร่ง" },
        { "id": 9, "name": "พิชัย อารีย์" },
        { "id": 10, "name": "ศุภชัย นิ่มนวล" },
        { "id": 11, "name": "อดิเรก พูนศักดิ์" },
        { "id": 12, "name": "ธนดล ใจบุญ" },
        { "id": 13, "name": "สุทธิพงษ์ ศักดิ์ชัย" },
        { "id": 14, "name": "เจษฎา คงทน" },
        { "id": 15, "name": "จิรภัทร ทองแท้" }
      ]
    };

    /* -------------------------------------
       อ่านค่าพารามิเตอร์
    -------------------------------------- */
    const params = new URLSearchParams(location.search);
    let dept = params.get("dept") || "ช่าง";
    const user = params.get("user") || "user1";

    // ตรวจสอบว่ามีแผนกจริงหรือไม่
    if (!employeesDB[dept]) {
      console.warn("Dept not found:", dept, " → ใช้ค่า 'เช็ค100% กะ1' แทน");
      dept = "เช็ค100% กะ2";
    }

    document.getElementById("meta").innerText = "แผนก: " + dept + " | ผู้ใช้: " + user;
    document.getElementById("titleDept").innerText = "เช็คชื่อ (" + dept + ")";

    /* -------------------------------------
       ฟังก์ชันโหลดรายชื่อ
    -------------------------------------- */
    function getEmployees() {
      return employeesDB[dept] || [];
    }

    function buildTable() {
      const employees = getEmployees();
      console.log("Loaded employees:", employees);

      const tbody = document.querySelector('#attTable tbody');
      tbody.innerHTML = '';

      employees.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.name}</td>
          <td><input type="checkbox" id="am_${e.id}" onchange="checkConflict(${e.id})"></td>
          <td><input type="checkbox" id="ot_${e.id}" onchange="checkConflict(${e.id})"></td>
          <td><input type="checkbox" id="abs_${e.id}" onchange="checkConflict(${e.id})"></td>
          <td>
            <select id="leave_${e.id}" class="input">
              <option value="">-</option>
              <option value="ลากิจ">ลากิจ</option>
              <option value="ลาป่วย">ลาป่วย</option>
              <option value="ลาพักร้อน">ลาพักร้อน</option>
            </select>
          </td>
          <td><input id="note_${e.id}" class="input"></td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* -------------------------------------
       ป้องกันเลือกสถานะซ้ำ
    -------------------------------------- */
    window.checkConflict = function (id) {
      const am = document.getElementById("am_" + id);
      const ot = document.getElementById("ot_" + id);
      const abs = document.getElementById("abs_" + id);

      if (abs.checked) {
        am.checked = false;
        ot.checked = false;
      }
      if (am.checked || ot.checked) {
        abs.checked = false;
      }
    };

    /* -------------------------------------
       โหลดตารางเมื่อ DOM พร้อม
    -------------------------------------- */
    document.addEventListener("DOMContentLoaded", buildTable);

    /* -------------------------------------
       ปุ่ม Logout
    -------------------------------------- */
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("user_login");
      window.location.href = "index.html";
    });

  </script>

</body>

</html>
