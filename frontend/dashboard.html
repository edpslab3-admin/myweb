<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>

  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body>

  <div class="container">

    <!-- Header -->
    <div class="header">
      <div class="logo">EP</div>
      <div>
        <h2 style="margin:0; color:var(--blue)">Dashboard</h2>
        <div class="small" id="meta"></div>
      </div>
    </div>

    <!-- Attendance Table -->
    <div class="card">
      <h3>เช็คชื่อ (20 คน)</h3>

      <table class="table" id="attTable">
        <thead>
          <tr>
            <th>ชื่อ</th>
            <th>เช้า</th>
            <th>OT</th>
            <th>ไม่มา</th>
            <th>ประเภทลา</th>
            <th>หมายเหตุ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn" id="saveBtn">บันทึก (เซฟที่ server)</button>
        <button class="btn" id="csvBtn">Export CSV</button>
        <button class="btn" id="xlsBtn">Export Excel</button>
      </div>
    </div>

    <!-- Summary Charts -->
    <div class="card">
      <h3>สรุป (วันนี้ และ 7 วัน)</h3>
      <div style="display:flex; gap:16px">
        <div style="flex:1"><canvas id="chartDay"></canvas></div>
        <div style="flex:1"><canvas id="chartWeek"></canvas></div>
      </div>
    </div>

  </div>

  <!-- Logout Button -->
  <div style="position:fixed; top:20px; right:20px;">
    <button id="logoutBtn"
      style="padding:10px 20px; background-color:#d9534f; color:white;
             border:none; border-radius:6px; cursor:pointer;">
      ออกจากระบบ
    </button>
  </div>

  <!-- Logout Script -->
  <script>
    document.getElementById("logoutBtn").addEventListener("click", function() {
      localStorage.removeItem("user_login");
      window.location.href = "/frontend/login.html";
    });
  </script>

  <!-- Main Script -->
  <script>
    const params = new URLSearchParams(location.search);
    const dept = params.get('dept') || '';
    const user = params.get('user') || 'user1';

    document.getElementById('meta').innerText = 'แผนก: ' + dept + ' | ผู้ใช้: ' + user;

    async function getEmployees() {
      try {
        const r = await fetch('/api/employees');
        if (!r.ok) throw 'no';
        const j = await r.json();
        if (j[dept]) return j[dept];
      } catch (e) {}
      return Array.from({length:20}, (_, i) => ({
        id: i + 1,
        name: 'พนักงาน ' + (i + 1)
      }));
    }

    async function buildTable() {
      const employees = await getEmployees();
      const tbody = document.querySelector('#attTable tbody');
      tbody.innerHTML = '';

      employees.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.name}</td>
          <td><input type="checkbox" id="am_${e.id}" onchange="checkConflict(${e.id})"></td>
          <td><input type="checkbox" id="ot_${e.id}" onchange="checkConflict(${e.id})"></td>
          <td><input type="checkbox" id="abs_${e.id}" onchange="checkConflict(${e.id})"></td>
          <td>
            <select id="leave_${e.id}" class="input">
              <option value="">-</option>
              <option value="ลากิจ">ลากิจ</option>
              <option value="ลาป่วย">ลาป่วย</option>
              <option value="ลาพักร้อน">ลาพักร้อน</option>
            </select>
          </td>
          <td><input id="note_${e.id}" class="input"></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // กันติ๊ก "มา" และ "ไม่มา" พร้อมกัน
    window.checkConflict = function(id) {
      const am = document.getElementById('am_' + id);
      const ot = document.getElementById('ot_' + id);
      const abs = document.getElementById('abs_' + id);

      if (abs.checked && (am.checked || ot.checked)) {
        am.checked = false;
        ot.checked = false;
      }

      if ((am.checked || ot.checked) && abs.checked) {
        abs.checked = false;
      }
    }

    function collectRecords() {
      const employees = document.querySelectorAll('#attTable tbody input[type="checkbox"]');
      const ids = new Set();

      employees.forEach(input => {
        const id = parseInt(input.id.split('_')[1]);
        ids.add(id);
      });

      const recs = [];
      ids.forEach(id => {
        recs.push({
          id: id,
          am: document.getElementById('am_' + id).checked,
          ot: document.getElementById('ot_' + id).checked,
          absent: document.getElementById('abs_' + id).checked,
          leave: document.getElementById('leave_' + id).value,
          note: document.getElementById('note_' + id).value
        });
      });
      return recs;
    }

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const records = collectRecords();
      const body = { dept, user, records };

      const r = await fetch('/api/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (r.ok) alert('บันทึกเรียบร้อย');
      else alert('บันทึกไม่สำเร็จ');

      renderCharts(records);
    });

    document.getElementById('csvBtn').addEventListener('click', () => {
      const recs = collectRecords();
      let csv = 'id,name,am,ot,absent,leave,note\n';

      recs.forEach(r => {
        csv += [
          r.id,
          'พนักงาน ' + r.id,
          r.am,
          r.ot,
          r.absent,
          r.leave || '',
          (r.note || '').replace(/\n/g, ' ')
        ].join(',') + '\n';
      });

      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8' }));
      a.download = 'attendance_' + (dept || 'all') + '.csv';
      a.click();
    });

    // Export เป็น Excel .xlsx ของจริง
    document.getElementById('xlsBtn').addEventListener('click', () => {
      const data = collectRecords().map(r => ({
        ID: r.id,
        Name: 'พนักงาน ' + r.id,
        Morning: r.am,
        OT: r.ot,
        Absent: r.absent,
        Leave: r.leave,
        Note: r.note
      }));

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
      XLSX.writeFile(wb, 'attendance_' + (dept || 'all') + '.xlsx');
    });

    function renderCharts(records) {
      const present = records.filter(r => r.am || r.ot).length;
      const absent = records.filter(r => r.absent).length;

      if (window._day) window._day.destroy();
      window._day = new Chart(document.getElementById('chartDay'), {
        type: 'bar',
        data: {
          labels: ['มา', 'ไม่มา'],
          datasets: [{ label: 'จำนวน', data: [present, absent] }]
        }
      });

      const labels = ['-6', '-5', '-4', '-3', '-2', '-1', 'วันนี้'];
      const data = labels.map(() => Math.floor(present / 2 + Math.random() * (present / 2)));

      if (window._wk) window._wk.destroy();
      window._wk = new Chart(document.getElementById('chartWeek'), {
        type: 'line',
        data: {
          labels,
          datasets: [{ label: 'คนมา', data, fill: false }]
        }
      });
    }

    window.addEventListener('load', buildTable);
  </script>

</body>
</html>
